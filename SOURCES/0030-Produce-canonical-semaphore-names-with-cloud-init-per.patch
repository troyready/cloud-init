From 502b7b83a43609968725fa44d6dad5d787ff037f Mon Sep 17 00:00:00 2001
From: Sean Kelly <seankell@amazon.com>
Date: Thu, 14 Jan 2016 22:46:23 +0000
Subject: [PATCH] Produce canonical semaphore names with cloud-init-per

Reviewed-by: Tom Kirchner <tjk@amazon.com>
Reviewed-by: Cyle Riggs <cyler@amazon.com>
---
 tools/cloud-init-per | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/tools/cloud-init-per b/tools/cloud-init-per
index 5d9a286..ac34e27 100755
--- a/tools/cloud-init-per
+++ b/tools/cloud-init-per
@@ -20,6 +20,7 @@ EOF
 }
 error() { echo "$@" 1>&2; }
 fail() { [ $# -eq 0 ] || error "$@"; exit 1; }
+canon_sem_name() { echo "$@" | sed 's|-|_|g'; }
 
 # support the old 'cloud-init-run-module freq name "execute" cmd arg1'
 # if < 3 arguments, it will fail below on usage.
@@ -42,10 +43,12 @@ shift 2;
 
 [ "${name#*/}" = "${name}" ] || fail "name cannot contain a /"
 [ "$(id -u)" = "0" ] || fail "must be root"
+# Emulate cloudinit.helpers.canon_sem_name for canonical semaphore names.
+canon_name="$(canon_sem_name $name)"
 
 case "$freq" in
-   once|always) sem="${DATA_PRE}.$name.$freq";;
-   instance) sem="${INST_PRE}.$name.$freq";;
+   once|always) sem="${DATA_PRE}.$canon_name.$freq";;
+   instance) sem="${INST_PRE}.$canon_name.$freq";;
    *) Usage 1>&2; fail "invalid frequency: $freq";;
 esac
 
-- 
2.4.3

